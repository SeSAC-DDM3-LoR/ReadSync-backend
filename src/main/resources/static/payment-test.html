<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toss Payment & Subscription Test</title>
    <!-- Toss Payments SDK -->
    <script src="https://js.tosspayments.com/v1/payment-widget"></script>
    <script src="https://js.tosspayments.com/v1/payment"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .section {
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .hidden {
            display: none;
        }

        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }

        input {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            box-sizing: border-box;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin-top: 15px;
            cursor: pointer;
            border-radius: 4px;
        }

        button:hover {
            background-color: #0056b3;
        }

        pre {
            background: #f4f4f4;
            padding: 10px;
            overflow-x: auto;
        }

        .success {
            color: green;
        }

        .error {
            color: red;
        }
    </style>
</head>

<body>

    <h1>ğŸ’³ Toss ê²°ì œ & êµ¬ë… í…ŒìŠ¤íŠ¸</h1>

    <div class="section">
        <h2>1. ì„¤ì • (Configuration)</h2>
        <label>JWT Token (Swaggerì—ì„œ ë¡œê·¸ì¸ í›„ ë³µì‚¬):</label>
        <input type="text" id="jwtToken" placeholder="Bearer ~ ì œì™¸í•˜ê³  í† í°ë§Œ ì…ë ¥ (ë˜ëŠ” Bearer í¬í•¨ë„ í—ˆìš©)">

        <label>Classes Key (Toss Client Key):</label>
        <input type="text" id="clientKey" placeholder="test_ck_...">
        <button onclick="saveConfig()">ì„¤ì • ì €ì¥</button>
    </div>

    <!-- íƒ­ ë©”ë‰´ -->
    <div style="margin-bottom: 10px;">
        <button onclick="showSection('cart')">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
        <button onclick="showSection('payment')">ì¼ë°˜ ê²°ì œ (Widget)</button>
        <button onclick="showSection('subscription')">ì •ê¸° êµ¬ë…</button>
    </div>

    <!-- ì¥ë°”êµ¬ë‹ˆ ì„¹ì…˜ -->
    <div id="cart" class="section hidden">
        <h2>ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</h2>
        <label>Book ID:</label>
        <input type="number" id="bookId" value="1">
        <label>Quantity:</label>
        <input type="number" id="quantity" value="1">
        <button onclick="addToCart()">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
        <button onclick="getCart()">ì¥ë°”êµ¬ë‹ˆ ì¡°íšŒ</button>
        <pre id="cartResult"></pre>
    </div>

    <!-- ê²°ì œ ì„¹ì…˜ -->
    <div id="payment" class="section hidden">
        <h2>ğŸ’° ì¼ë°˜ ê²°ì œ (Payment Widget)</h2>
        <p>ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ ì´ì•¡ì„ í™•ì¸ í›„ ê²°ì œí•©ë‹ˆë‹¤.</p>
        <label>Order Name (ì£¼ë¬¸ëª…):</label>
        <input type="text" id="orderName" value="í…ŒìŠ¤íŠ¸ ì„œì  ì™¸ 1ê±´">
        <label>Amount (ì´ ê¸ˆì•¡):</label>
        <input type="number" id="amount" value="15000">

        <div id="payment-widget"></div>
        <div id="agreement"></div>
        <button onclick="requestPayment()">ê²°ì œí•˜ê¸°</button>
    </div>

    <!-- êµ¬ë… ì„¹ì…˜ -->
    <div id="subscription" class="section hidden">
        <h2>ğŸ“… ì •ê¸° êµ¬ë… (Billing Auth)</h2>
        <button onclick="requestBillingAuth()">ì¹´ë“œ ë“±ë¡ (ë¹Œë§í‚¤ ë°œê¸‰)</button>
        <hr>
        <label>Plan ID (í”Œëœ ID):</label>
        <input type="number" id="planId" value="2" placeholder="1: Basic, 2: Premium, 3: Family">
        <button onclick="subscribe()">êµ¬ë… ì‹ ì²­</button>
        <button onclick="getMySubscription()" style="background-color: #6c757d;">ë‚´ êµ¬ë… ì •ë³´ ì¡°íšŒ</button>
        <pre id="subResult"></pre>
    </div>

    <!-- ... (Log section unchanged) ... -->

    <script>
        // ... (methods above unchanged) ...

        function subscribe() {
            const planId = document.getElementById('planId').value;

            // API í˜¸ì¶œ
            fetch(`/api/v1/subscriptions?planId=${planId}`, {
                method: 'POST',
                headers: getAuthHeader()
            })
                .then(res => res.ok ? res.json() : Promise.reject(res))
                .then(data => {
                    log('êµ¬ë… ì„±ê³µ: ' + JSON.stringify(data));
                    document.getElementById('subResult').innerText = JSON.stringify(data, null, 2);
                })
                .catch(async err => log('êµ¬ë… ì—ëŸ¬: ' + (err.json ? JSON.stringify(await err.json()) : err), true));
        }

        function getMySubscription() {
            fetch(`/api/v1/subscriptions/me`, {
                headers: getAuthHeader()
            })
                .then(res => {
                    if (res.status === 204) return "êµ¬ë… ì •ë³´ ì—†ìŒ";
                    return res.ok ? res.json() : Promise.reject(res);
                })
                .then(data => {
                    log('êµ¬ë… ì¡°íšŒ: ' + JSON.stringify(data));
                    document.getElementById('subResult').innerText = JSON.stringify(data, null, 2);
                })
                .catch(async err => log('ì¡°íšŒ ì—ëŸ¬: ' + (err.json ? JSON.stringify(await err.json()) : err), true));
        }



        // --- ë¦¬ë‹¤ì´ë ‰íŠ¸ ì²˜ë¦¬ ë¡œì§ ---
        function processRedirect() {
            const urlParams = new URLSearchParams(window.location.search);
            let processed = false;

            // 1. ì¼ë°˜ ê²°ì œ ì„±ê³µ (paymentKey, orderId, amount)
            if (urlParams.has('paymentKey') && urlParams.has('orderId') && urlParams.has('amount')) {
                log('ê²°ì œ ì¸ì¦ ì„±ê³µ! ë°±ì—”ë“œ ìŠ¹ì¸ ìš”ì²­ ì¤‘...');
                processed = true;
                const body = {
                    paymentKey: urlParams.get('paymentKey'),
                    orderId: urlParams.get('orderId'),
                    amount: parseInt(urlParams.get('amount'))
                };

                fetch('/api/v1/payments/confirm', {
                    method: 'POST',
                    headers: getAuthHeader(),
                    body: JSON.stringify(body)
                })
                    .then(res => res.ok ? res.json() : Promise.reject(res))
                    .then(data => {
                        log('âœ… ìµœì¢… ê²°ì œ ìŠ¹ì¸ ì™„ë£Œ: ' + JSON.stringify(data));
                        alert('ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    })
                    .catch(async err => {
                        log('âŒ ê²°ì œ ìŠ¹ì¸ ì‹¤íŒ¨: ' + (err.json ? JSON.stringify(await err.json()) : err), true);
                        alert('ê²°ì œ ìŠ¹ì¸ ì‹¤íŒ¨. ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
                    });
            }

            // 2. ë¹Œë§í‚¤ ë°œê¸‰ ì„±ê³µ (authKey, customerKey)
            else if (urlParams.has('authKey') && urlParams.has('customerKey')) {
                log('ë¹Œë§ ì¸ì¦ ì„±ê³µ! ë°±ì—”ë“œ í‚¤ ë“±ë¡ ìš”ì²­ ì¤‘...');
                processed = true;
                const body = {
                    authKey: urlParams.get('authKey'),
                    customerKey: urlParams.get('customerKey')
                };

                fetch('/api/v1/payments/billing-key', {
                    method: 'POST',
                    headers: getAuthHeader(),
                    body: JSON.stringify(body)
                })
                    .then(res => res.ok ? log('âœ… ë¹Œë§í‚¤ ë“±ë¡ ì™„ë£Œ! ì´ì œ êµ¬ë…ì„ ì‹ ì²­í•˜ì„¸ìš”.') : Promise.reject(res))
                    .catch(async err => {
                        log('âŒ ë¹Œë§í‚¤ ë“±ë¡ ì‹¤íŒ¨: ' + (err.json ? JSON.stringify(await err.json()) : err), true);
                    });
            }

            // 3. ì‹¤íŒ¨ (code, message)
            else if (urlParams.has('code')) {
                log('âŒ Toss ì¸ì¦ ì‹¤íŒ¨: ' + urlParams.get('message'), true);
                processed = true;
            }

            // URL íŒŒë¼ë¯¸í„° ì²­ì†Œ
            if (processed) {
                const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                window.history.replaceState({ path: newUrl }, '', newUrl);
            }
        }
    </script>
</body>

</html>