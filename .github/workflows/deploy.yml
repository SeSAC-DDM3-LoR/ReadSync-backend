name: ReadSync Backend CI/CD

# main ë¸Œëœì¹˜ì— pushë  ë•Œë§Œ ì‹¤í–‰
on:
  push:
    branches: [ "main" ]

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
env:
  JAVA_VERSION: '21'
  AWS_REGION: 'ap-northeast-2'
  EB_APPLICATION_NAME: 'readsync-server'
  EB_ENVIRONMENT_NAME: 'Readsync-server-env'

jobs:
  # ========================================
  # ë¹Œë“œ, í…ŒìŠ¤íŠ¸ ë° EB ë°°í¬
  # ========================================
  build-deploy:
    name: Build and Deploy to Elastic Beanstalk
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Java 21 ì„¤ì • (Amazon Corretto)
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      # 3. Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 4. Gradle ì˜ì¡´ì„± ìºì‹± (ë¹Œë“œ ì†ë„ í–¥ìƒ)
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 5. ë¹Œë“œ (í…ŒìŠ¤íŠ¸ í¬í•¨ - ì•ˆì •ì„± í™•ë³´)
      # í…ŒìŠ¤íŠ¸ ì œì™¸í•˜ë ¤ë©´: ./gradlew clean build -x test --no-daemon
      # ./gradlew clean build --no-daemon
      - name: Build with Gradle
        run: ./gradlew clean build -x test --no-daemon
        env:
          SPRING_PROFILES_ACTIVE: prod

      # 6. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ (ì‹¤íŒ¨ ì‹œ ë””ë²„ê¹…ìš©)
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: build/test-results/
          retention-days: 7

      # 7. EB ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±
      - name: Generate deployment package
        run: |
          # 1. ê¸°ì¡´ ë°°í¬ í´ë”ê°€ ìˆë‹¤ë©´ ì‚­ì œí•˜ê³  ìƒˆë¡œ ìƒì„±
          rm -rf deploy && mkdir deploy
          
          # 2. Dockerfile ë³µì‚¬
          cp Dockerfile.deploy deploy/Dockerfile
          
          # 3. ë¹Œë“œëœ JAR íŒŒì¼ ë³µì‚¬ (plain JAR ì œì™¸, ì‹¤ì œ ì‹¤í–‰ ê°€ëŠ¥í•œ JARë§Œ)
          # build/libs í´ë”ì— JARê°€ í•˜ë‚˜ë§Œ ìƒê¸°ë„ë¡ ì„¤ì •ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
          cp build/libs/*-SNAPSHOT.jar deploy/app.jar || cp build/libs/*.jar deploy/app.jar
          
          # 4. ì••ì¶• (ë°˜ë“œì‹œ deploy í´ë” ì•ˆì—ì„œ ì‹¤í–‰í•˜ì—¬ ë£¨íŠ¸ì— íŒŒì¼ë“¤ì´ ìœ„ì¹˜í•˜ê²Œ í•¨)
          cd deploy
          zip -r ../deploy.zip .
          
          # 5. êµ¬ì„± í™•ì¸ (ë¡œê·¸ì—ì„œ íŒŒì¼ ëª©ë¡ í™•ì¸ìš©)
          ls -R

      # 8. Elastic Beanstalk ë°°í¬
      - name: Deploy to Elastic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v21
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          application_name: ${{ env.EB_APPLICATION_NAME }}
          environment_name: ${{ env.EB_ENVIRONMENT_NAME }}
          version_label: v${{ github.run_number }}-${{ github.sha }}
          region: ${{ env.AWS_REGION }}
          deployment_package: deploy.zip
          wait_for_deployment: true
          wait_for_environment_recovery: 300
          use_existing_version_if_available: true

      # 9. ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… ë°°í¬ ì„±ê³µ! Environment: ${{ env.EB_ENVIRONMENT_NAME }}"
            echo "ğŸš€ Version: v${{ github.run_number }}-${{ github.sha }}"
          else
            echo "âŒ ë°°í¬ ì‹¤íŒ¨! ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
          fi
